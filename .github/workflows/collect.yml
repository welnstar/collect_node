name: Daily Multi-Config Update

on:
  schedule:
    - cron: '10 0 * * *'  # UTC 00:10 = åŒ—äº¬æ—¶é—´ 08:10
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.REPO_ACCESS_TOKEN }}

    - name: Generate date contexts (Beijing Time Â±2 days)
      id: dates
      run: |
        # Today (Beijing = UTC+8)
        BJ_TODAY_YMD=$(date -u -d '+8 hours' +%Y%m%d)
        BJ_TODAY_YEAR=$(date -u -d '+8 hours' +%Y)
        BJ_TODAY_MONTH=$(date -u -d '+8 hours' +%m)
        BJ_TODAY_DAY=$(date -u -d '+8 hours' +%d)

        # Yesterday
        BJ_YESTERDAY_YMD=$(date -u -d '+8 hours -1 day' +%Y%m%d)
        BJ_YESTERDAY_YEAR=$(date -u -d '+8 hours -1 day' +%Y)
        BJ_YESTERDAY_MONTH=$(date -u -d '+8 hours -1 day' +%m)
        BJ_YESTERDAY_DAY=$(date -u -d '+8 hours -1 day' +%d)

        # 2 Days Ago
        BJ_2DAYSAGO_YMD=$(date -u -d '+8 hours -2 days' +%Y%m%d)
        BJ_2DAYSAGO_YEAR=$(date -u -d '+8 hours -2 days' +%Y)
        BJ_2DAYSAGO_MONTH=$(date -u -d '+8 hours -2 days' +%m)
        BJ_2DAYSAGO_DAY=$(date -u -d '+8 hours -2 days' +%d)

        # Output
        echo "BJ_TODAY_YMD=$BJ_TODAY_YMD" >> "$GITHUB_OUTPUT"
        echo "BJ_TODAY_YEAR=$BJ_TODAY_YEAR" >> "$GITHUB_OUTPUT"
        echo "BJ_TODAY_MONTH=$BJ_TODAY_MONTH" >> "$GITHUB_OUTPUT"
        echo "BJ_TODAY_DAY=$BJ_TODAY_DAY" >> "$GITHUB_OUTPUT"

        echo "BJ_YESTERDAY_YMD=$BJ_YESTERDAY_YMD" >> "$GITHUB_OUTPUT"
        echo "BJ_YESTERDAY_YEAR=$BJ_YESTERDAY_YEAR" >> "$GITHUB_OUTPUT"
        echo "BJ_YESTERDAY_MONTH=$BJ_YESTERDAY_MONTH" >> "$GITHUB_OUTPUT"
        echo "BJ_YESTERDAY_DAY=$BJ_YESTERDAY_DAY" >> "$GITHUB_OUTPUT"

        echo "BJ_2DAYSAGO_YMD=$BJ_2DAYSAGO_YMD" >> "$GITHUB_OUTPUT"
        echo "BJ_2DAYSAGO_YEAR=$BJ_2DAYSAGO_YEAR" >> "$GITHUB_OUTPUT"
        echo "BJ_2DAYSAGO_MONTH=$BJ_2DAYSAGO_MONTH" >> "$GITHUB_OUTPUT"
        echo "BJ_2DAYSAGO_DAY=$BJ_2DAYSAGO_DAY" >> "$GITHUB_OUTPUT"

    - name: Download configs with date fallback and content validation
      env:
        # Today
        BJ_TODAY_YEAR: ${{ steps.dates.outputs.BJ_TODAY_YEAR }}
        BJ_TODAY_MONTH: ${{ steps.dates.outputs.BJ_TODAY_MONTH }}
        BJ_TODAY_DAY: ${{ steps.dates.outputs.BJ_TODAY_DAY }}
        BJ_TODAY_YMD: ${{ steps.dates.outputs.BJ_TODAY_YMD }}
        # Yesterday
        BJ_YESTERDAY_YEAR: ${{ steps.dates.outputs.BJ_YESTERDAY_YEAR }}
        BJ_YESTERDAY_MONTH: ${{ steps.dates.outputs.BJ_YESTERDAY_MONTH }}
        BJ_YESTERDAY_DAY: ${{ steps.dates.outputs.BJ_YESTERDAY_DAY }}
        BJ_YESTERDAY_YMD: ${{ steps.dates.outputs.BJ_YESTERDAY_YMD }}
        # 2 Days Ago
        BJ_2DAYSAGO_YEAR: ${{ steps.dates.outputs.BJ_2DAYSAGO_YEAR }}
        BJ_2DAYSAGO_MONTH: ${{ steps.dates.outputs.BJ_2DAYSAGO_MONTH }}
        BJ_2DAYSAGO_DAY: ${{ steps.dates.outputs.BJ_2DAYSAGO_DAY }}
        BJ_2DAYSAGO_YMD: ${{ steps.dates.outputs.BJ_2DAYSAGO_YMD }}
      run: |
        echo "ðŸ“… Beijing Today: $BJ_TODAY_YEAR-$BJ_TODAY_MONTH-$BJ_TODAY_DAY"
        echo "ðŸ“… Beijing Yesterday: $BJ_YESTERDAY_YEAR-$BJ_YESTERDAY_MONTH-$BJ_YESTERDAY_DAY"
        echo "ðŸ“… Beijing 2 Days Ago: $BJ_2DAYSAGO_YEAR-$BJ_2DAYSAGO_MONTH-$BJ_2DAYSAGO_DAY"

        CONFIG_LIST=(
          # Standard sources (freeclashnode)
          "https://node.freeclashnode.com/uploads/{{year}}/{{month}}/0-{{ymd}}.yaml;freeclashnode-0_latest.yaml"
          "https://node.freeclashnode.com/uploads/{{year}}/{{month}}/1-{{ymd}}.yaml;freeclashnode-1_latest.yaml"
          "https://node.freeclashnode.com/uploads/{{year}}/{{month}}/2-{{ymd}}.yaml;freeclashnode-2_latest.yaml"
          "https://node.freeclashnode.com/uploads/{{year}}/{{month}}/3-{{ymd}}.yaml;freeclashnode-3_latest.yaml"
          "https://node.freeclashnode.com/uploads/{{year}}/{{month}}/4-{{ymd}}.yaml;freeclashnode-4_latest.yaml"

          # Special source: mibei77.com â†’ uses MONTH.DAY format (e.g., 12.01Clashikf.yaml)
          "https://mm.mibei77.com/{{year}}.{{month}}/{{month}}.{{day}}Clashikf.yaml;mibei77_latest.yaml"
        )

        DATE_FALLBACK=(
          "today"
          "yesterday"
          "two_days_ago"
        )

        for config in "${CONFIG_LIST[@]}"; do
          IFS=';' read -r URL_TEMPLATE OUTPUT_NAME <<< "$config"
          rm -f "$OUTPUT_NAME"
          downloaded=false

          echo "ðŸ” Processing $OUTPUT_NAME..."

          for date_key in "${DATE_FALLBACK[@]}"; do
            case "$date_key" in
              "today")
                Y="$BJ_TODAY_YEAR"; M="$BJ_TODAY_MONTH"; D="$BJ_TODAY_DAY"; YMD="$BJ_TODAY_YMD"
                ;;
              "yesterday")
                Y="$BJ_YESTERDAY_YEAR"; M="$BJ_YESTERDAY_MONTH"; D="$BJ_YESTERDAY_DAY"; YMD="$BJ_YESTERDAY_YMD"
                ;;
              "two_days_ago")
                Y="$BJ_2DAYSAGO_YEAR"; M="$BJ_2DAYSAGO_MONTH"; D="$BJ_2DAYSAGO_DAY"; YMD="$BJ_2DAYSAGO_YMD"
                ;;
            esac

            RENDERED_URL="$URL_TEMPLATE"
            RENDERED_URL="${RENDERED_URL//{{year}}/$Y}"
            RENDERED_URL="${RENDERED_URL//{{month}}/$M}"
            RENDERED_URL="${RENDERED_URL//{{day}}/$D}"
            RENDERED_URL="${RENDERED_URL//{{ymd}}/$YMD}"

            echo "  â†’ Trying: $RENDERED_URL"

            # Download with browser-like User-Agent (avoid anti-bot)
            if curl -f -L -A "Mozilla/5.0 (compatible; GitHub-Actions)" \
                    --retry 2 --retry-delay 3 --max-time 25 \
                    -o "$OUTPUT_NAME" "$RENDERED_URL"; then

              # Validate: non-empty AND contains 'proxies:' (Clash config signature)
              if [ -s "$OUTPUT_NAME" ] && grep -q 'proxies:' "$OUTPUT_NAME"; then
                echo "  âœ… Valid config saved: $OUTPUT_NAME (from $date_key)"
                downloaded=true
                break
              else
                echo "  âš ï¸ Invalid content (empty or not a Clash config)"
                rm -f "$OUTPUT_NAME"
              fi
            else
              echo "  âš ï¸ Download failed (HTTP error or timeout)"
            fi
          done

          if [ "$downloaded" = false ]; then
            echo "::warning::No valid config found for $OUTPUT_NAME after 3-day fallback"
          fi
        done

    - name: Debug - List downloaded files
      run: |
        echo "ðŸ“¥ Downloaded files:"
        ls -la *_latest.* 2>/dev/null || echo "No _latest files found."

    - name: Check for actual Git changes
      id: git_check
      run: |
        if [ -n "$(git status --porcelain)" ]; then
          echo "has_changes=true" >> "$GITHUB_OUTPUT"
          echo "Changes detected:"
          git status --porcelain
        else
          echo "has_changes=false" >> "$GITHUB_OUTPUT"
          echo "No changes to commit."
        fi

    - name: Commit and push changes
      if: steps.git_check.outputs.has_changes == 'true'
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "Bot: Daily config update (Beijing ${{ steps.dates.outputs.BJ_TODAY_YMD }})"
        file_pattern: '*_latest.*'
        add_options: '-A'
        token: ${{ secrets.REPO_ACCESS_TOKEN }}
        skip_dirty_check: true
        commit_user_name: 'github-actions[bot]'
        commit_user_email: 'github-actions[bot]@users.noreply.github.com'
