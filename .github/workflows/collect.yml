name: Daily Multi-Config Update

on:
  schedule:
    - cron: '10 0 * * *'  # æ¯å¤© UTC 00:10 è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´ 08:10ï¼Œç¡®ä¿æºç«™å·²æ›´æ–°ï¼‰
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.REPO_ACCESS_TOKEN }}

    - name: Generate date candidates (UTC and Beijing)
      id: dates
      run: |
        # UTC æ—¥æœŸ
        UTC_TODAY=$(date -u +%Y%m%d)
        UTC_YESTERDAY=$(date -u -d '1 day ago' +%Y%m%d)
        
        # åŒ—äº¬æ—¶é—´ï¼ˆUTC+8ï¼‰æ—¥æœŸ
        BJ_TODAY=$(date -u -d '+8 hours' +%Y%m%d)
        BJ_YESTERDAY=$(date -u -d '+8 hours -1 day' +%Y%m%d)
        
        # æŒ‰ä¼˜å…ˆçº§æ’åºï¼šå…ˆè¯•åŒ—äº¬æ—¶é—´ä»Šå¤©ï¼Œå†æ˜¨å¤©ï¼Œå† UTC ä»Šå¤©ï¼ˆé€‚åº”ä¸­å›½æºç«™ï¼‰
        echo "DATE_LIST=${BJ_TODAY},${BJ_YESTERDAY},${UTC_TODAY},${UTC_YESTERDAY}" >> "$GITHUB_OUTPUT"

    - name: Download configs with date fallback
      run: |
        CONFIG_LIST=(
          "https://node.freeclashnode.com/uploads;4-;.yaml;node_latest.yaml"
          "https://rule.freeclashrule.com/rules;5-;.list;rule_latest.list"
          # å¯åœ¨æ­¤æ·»åŠ æ›´å¤šé…ç½®...
        )

        # è¯»å–æ—¥æœŸå€™é€‰åˆ—è¡¨
        IFS=',' read -r -a DATES <<< "${{ steps.dates.outputs.DATE_LIST }}"

        for config in "${CONFIG_LIST[@]}"; do
          IFS=';' read -r BASE_URL PREFIX SUFFIX OUTPUT_NAME <<< "$config"
          downloaded=false

          echo "ğŸ” Processing $OUTPUT_NAME..."

          for try_date in "${DATES[@]}"; do
            YEAR=${try_date:0:4}
            MONTH=${try_date:4:2}
            FULL_URL="${BASE_URL}/${YEAR}/${MONTH}/${PREFIX}${try_date}${SUFFIX}"

            echo "  â†’ Trying: $FULL_URL"

            if curl -f -L --retry 2 --retry-delay 3 --max-time 25 -o "${OUTPUT_NAME}" "${FULL_URL}"; then
              echo "  âœ… Success! Saved as $OUTPUT_NAME (date: $try_date)"
              downloaded=true
              break
            else
              echo "  âš ï¸  Failed: $FULL_URL"
            fi
          done

          if [ "$downloaded" = false ]; then
            echo "::warning::All date attempts failed for $OUTPUT_NAME. Skipping."
            # ä¸åˆ›å»ºç©ºæ–‡ä»¶ï¼Œé¿å…æ±¡æŸ“ä»“åº“
          fi
        done

    - name: Check if any valid config files exist
      id: check
      run: |
        if ls *_latest.* 1> /dev/null 2>&1; then
          echo "has_files=true" >> "$GITHUB_OUTPUT"
        else
          echo "has_files=false" >> "$GITHUB_OUTPUT"
        fi

    - name: Commit and push (only if files exist)
      if: steps.check.outputs.has_files == 'true'
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "Bot: Daily config update ($(date -u +%Y%m%d))"
        file_pattern: '*_latest.*'
        token: ${{ secrets.REPO_ACCESS_TOKEN }}
        skip_dirty_check: true  # é˜²æ­¢å› æ¢è¡Œç¬¦ç­‰é—®é¢˜æŠ¥é”™
