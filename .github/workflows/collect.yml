name: Daily Multi-Config Update

on:
  schedule:
    - cron: '10 0 * * *'  # æ¯å¤© UTC 00:10ï¼ˆåŒ—äº¬æ—¶é—´ 08:10ï¼‰
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.REPO_ACCESS_TOKEN }}

    - name: Generate date contexts (UTC and Beijing)
      id: dates
      run: |
        # UTC
        UTC_YEAR=$(date -u +%Y)
        UTC_MONTH=$(date -u +%m)
        UTC_DAY=$(date -u +%d)
        UTC_YMD=$(date -u +%Y%m%d)

        # Beijing Time (UTC+8)
        BJ_YEAR=$(date -u -d '+8 hours' +%Y)
        BJ_MONTH=$(date -u -d '+8 hours' +%m)
        BJ_DAY=$(date -u -d '+8 hours' +%d)
        BJ_YMD=$(date -u -d '+8 hours' +%Y%m%d)

        # Beijing Yesterday
        BJ_YESTERDAY_YEAR=$(date -u -d '+8 hours -1 day' +%Y)
        BJ_YESTERDAY_MONTH=$(date -u -d '+8 hours -1 day' +%m)
        BJ_YESTERDAY_DAY=$(date -u -d '+8 hours -1 day' +%d)
        BJ_YESTERDAY_YMD=$(date -u -d '+8 hours -1 day' +%Y%m%d)

        # Output to GITHUB_OUTPUT
        echo "BJ_YEAR=$BJ_YEAR" >> "$GITHUB_OUTPUT"
        echo "BJ_MONTH=$BJ_MONTH" >> "$GITHUB_OUTPUT"
        echo "BJ_DAY=$BJ_DAY" >> "$GITHUB_OUTPUT"
        echo "BJ_YMD=$BJ_YMD" >> "$GITHUB_OUTPUT"
        echo "BJ_YESTERDAY_YEAR=$BJ_YESTERDAY_YEAR" >> "$GITHUB_OUTPUT"
        echo "BJ_YESTERDAY_MONTH=$BJ_YESTERDAY_MONTH" >> "$GITHUB_OUTPUT"
        echo "BJ_YESTERDAY_DAY=$BJ_YESTERDAY_DAY" >> "$GITHUB_OUTPUT"
        echo "BJ_YESTERDAY_YMD=$BJ_YESTERDAY_YMD" >> "$GITHUB_OUTPUT"
        echo "UTC_YEAR=$UTC_YEAR" >> "$GITHUB_OUTPUT"
        echo "UTC_MONTH=$UTC_MONTH" >> "$GITHUB_OUTPUT"
        echo "UTC_DAY=$UTC_DAY" >> "$GITHUB_OUTPUT"
        echo "UTC_YMD=$UTC_YMD" >> "$GITHUB_OUTPUT"

    - name: Download configs with universal template
      run: |
        CONFIG_LIST=(
          # Standard sources (freeclashnode)
          "https://node.freeclashnode.com/uploads/{{year}}/{{month}}/0-{{ymd}}.yaml;freeclashnode-0_latest.yaml"
          "https://node.freeclashnode.com/uploads/{{year}}/{{month}}/1-{{ymd}}.yaml;freeclashnode-1_latest.yaml"
          "https://node.freeclashnode.com/uploads/{{year}}/{{month}}/2-{{ymd}}.yaml;freeclashnode-2_latest.yaml"
          "https://node.freeclashnode.com/uploads/{{year}}/{{month}}/3-{{ymd}}.yaml;freeclashnode-3_latest.yaml"
          "https://node.freeclashnode.com/uploads/{{year}}/{{month}}/4-{{ymd}}.yaml;freeclashnode-4_latest.yaml"

          # Special source (mibei77)
          "https://mm.mibei77.com/{{year}}.{{month}}/{{day}}.{{month}}Clashikf.yaml;mibei77_latest.yaml"

          # Add more sources here as needed
        )

        DATE_FALLBACK=(
          "bj_today"
          "bj_yesterday"
          "utc_today"
        )

        for config in "${CONFIG_LIST[@]}"; do
          IFS=';' read -r URL_TEMPLATE OUTPUT_NAME <<< "$config"

          # Ensure clean state: remove any existing file
          rm -f "$OUTPUT_NAME"

          downloaded=false
          echo "ðŸ” Processing $OUTPUT_NAME..."

          for date_key in "${DATE_FALLBACK[@]}"; do
            case "$date_key" in
              "bj_today")
                Y=${{ steps.dates.outputs.BJ_YEAR }}
                M=${{ steps.dates.outputs.BJ_MONTH }}
                D=${{ steps.dates.outputs.BJ_DAY }}
                YMD=${{ steps.dates.outputs.BJ_YMD }}
                ;;
              "bj_yesterday")
                Y=${{ steps.dates.outputs.BJ_YESTERDAY_YEAR }}
                M=${{ steps.dates.outputs.BJ_YESTERDAY_MONTH }}
                D=${{ steps.dates.outputs.BJ_YESTERDAY_DAY }}
                YMD=${{ steps.dates.outputs.BJ_YESTERDAY_YMD }}
                ;;
              "utc_today")
                Y=${{ steps.dates.outputs.UTC_YEAR }}
                M=${{ steps.dates.outputs.UTC_MONTH }}
                D=${{ steps.dates.outputs.UTC_DAY }}
                YMD=${{ steps.dates.outputs.UTC_YMD }}
                ;;
            esac

            RENDERED_URL="$URL_TEMPLATE"
            RENDERED_URL="${RENDERED_URL//{{year}}/$Y}"
            RENDERED_URL="${RENDERED_URL//{{month}}/$M}"
            RENDERED_URL="${RENDERED_URL//{{day}}/$D}"
            RENDERED_URL="${RENDERED_URL//{{ymd}}/$YMD}"

            echo "  â†’ Trying: $RENDERED_URL"

            if curl -f -L --retry 2 --retry-delay 3 --max-time 25 -o "$OUTPUT_NAME" "$RENDERED_URL"; then
              echo "  âœ… Success! Saved as $OUTPUT_NAME (date: $date_key)"
              downloaded=true
              break
            else
              echo "  âš ï¸ Failed: $RENDERED_URL"
            fi
          done

          if [ "$downloaded" = false ]; then
            # Clean up: ensure no invalid/empty file remains
            rm -f "$OUTPUT_NAME"
            echo "::warning::All attempts failed for $OUTPUT_NAME"
          fi
        done

    - name: Check for actual Git changes (modified, added, or deleted files)
      id: git_check
      run: |
        # git status --porcelain outputs nothing if clean
        if [ -n "$(git status --porcelain)" ]; then
          echo "has_changes=true" >> "$GITHUB_OUTPUT"
          echo "Detected changes:"
          git status --porcelain
        else
          echo "has_changes=false" >> "$GITHUB_OUTPUT"
          echo "Working tree is clean. Skipping commit."
        fi

    - name: Commit and push changes
      if: steps.git_check.outputs.has_changes == 'true'
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "Bot: Daily config update ($(date -u +%Y%m%d))"
        file_pattern: '*_latest.*'
        add_options: '-A'  # Add new and modified files
        token: ${{ secrets.REPO_ACCESS_TOKEN }}
        skip_dirty_check: true
        commit_user_name: 'github-actions[bot]'
        commit_user_email: 'github-actions[bot]@users.noreply.github.com'
