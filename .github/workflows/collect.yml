name: Daily Multi-Config Update

on:
  schedule:
    - cron: '10 0 * * *'  # UTC 00:10 = åŒ—äº¬æ—¶é—´ 08:10
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    environment: daily-config
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.REPO_ACCESS_TOKEN }}

    - name: Generate date contexts (Beijing Time Â±2 days)
      id: dates
      run: |
        # Today (Beijing = UTC+8)
        BJ_TODAY_YMD=$(date -u -d '+8 hours' +%Y%m%d)
        BJ_TODAY_YEAR=$(date -u -d '+8 hours' +%Y)
        BJ_TODAY_MONTH=$(date -u -d '+8 hours' +%m)
        BJ_TODAY_DAY=$(date -u -d '+8 hours' +%d)

        # Yesterday
        BJ_YESTERDAY_YMD=$(date -u -d '+8 hours -1 day' +%Y%m%d)
        BJ_YESTERDAY_YEAR=$(date -u -d '+8 hours -1 day' +%Y)
        BJ_YESTERDAY_MONTH=$(date -u -d '+8 hours -1 day' +%m)
        BJ_YESTERDAY_DAY=$(date -u -d '+8 hours -1 day' +%d)

        # 2 Days Ago
        BJ_2DAYSAGO_YMD=$(date -u -d '+8 hours -2 days' +%Y%m%d)
        BJ_2DAYSAGO_YEAR=$(date -u -d '+8 hours -2 days' +%Y)
        BJ_2DAYSAGO_MONTH=$(date -u -d '+8 hours -2 days' +%m)
        BJ_2DAYSAGO_DAY=$(date -u -d '+8 hours -2 days' +%d)

        # Output
        echo "BJ_TODAY_YMD=$BJ_TODAY_YMD" >> "$GITHUB_OUTPUT"
        echo "BJ_TODAY_YEAR=$BJ_TODAY_YEAR" >> "$GITHUB_OUTPUT"
        echo "BJ_TODAY_MONTH=$BJ_TODAY_MONTH" >> "$GITHUB_OUTPUT"
        echo "BJ_TODAY_DAY=$BJ_TODAY_DAY" >> "$GITHUB_OUTPUT"

        echo "BJ_YESTERDAY_YMD=$BJ_YESTERDAY_YMD" >> "$GITHUB_OUTPUT"
        echo "BJ_YESTERDAY_YEAR=$BJ_YESTERDAY_YEAR" >> "$GITHUB_OUTPUT"
        echo "BJ_YESTERDAY_MONTH=$BJ_YESTERDAY_MONTH" >> "$GITHUB_OUTPUT"
        echo "BJ_YESTERDAY_DAY=$BJ_YESTERDAY_DAY" >> "$GITHUB_OUTPUT"

        echo "BJ_2DAYSAGO_YMD=$BJ_2DAYSAGO_YMD" >> "$GITHUB_OUTPUT"
        echo "BJ_2DAYSAGO_YEAR=$BJ_2DAYSAGO_YEAR" >> "$GITHUB_OUTPUT"
        echo "BJ_2DAYSAGO_MONTH=$BJ_2DAYSAGO_MONTH" >> "$GITHUB_OUTPUT"
        echo "BJ_2DAYSAGO_DAY=$BJ_2DAYSAGO_DAY" >> "$GITHUB_OUTPUT"

    - name: Download configs with safe URL replacement (using sed)
      env:
        CONFIG_LIST: ${{ vars.CONFIG_LIST }}
        # Today
        BJ_TODAY_YEAR: ${{ steps.dates.outputs.BJ_TODAY_YEAR }}
        BJ_TODAY_MONTH: ${{ steps.dates.outputs.BJ_TODAY_MONTH }}
        BJ_TODAY_DAY: ${{ steps.dates.outputs.BJ_TODAY_DAY }}
        BJ_TODAY_YMD: ${{ steps.dates.outputs.BJ_TODAY_YMD }}
        # Yesterday
        BJ_YESTERDAY_YEAR: ${{ steps.dates.outputs.BJ_YESTERDAY_YEAR }}
        BJ_YESTERDAY_MONTH: ${{ steps.dates.outputs.BJ_YESTERDAY_MONTH }}
        BJ_YESTERDAY_DAY: ${{ steps.dates.outputs.BJ_YESTERDAY_DAY }}
        BJ_YESTERDAY_YMD: ${{ steps.dates.outputs.BJ_YESTERDAY_YMD }}
        # 2 Days Ago
        BJ_2DAYSAGO_YEAR: ${{ steps.dates.outputs.BJ_2DAYSAGO_YEAR }}
        BJ_2DAYSAGO_MONTH: ${{ steps.dates.outputs.BJ_2DAYSAGO_MONTH }}
        BJ_2DAYSAGO_DAY: ${{ steps.dates.outputs.BJ_2DAYSAGO_DAY }}
        BJ_2DAYSAGO_YMD: ${{ steps.dates.outputs.BJ_2DAYSAGO_YMD }}
      run: |
        echo "ðŸ“… Beijing Today: $BJ_TODAY_YEAR-$BJ_TODAY_MONTH-$BJ_TODAY_DAY (YMD: $BJ_TODAY_YMD)"
        echo "ðŸ“… Beijing Yesterday: $BJ_YESTERDAY_YEAR-$BJ_YESTERDAY_MONTH-$BJ_YESTERDAY_DAY (YMD: $BJ_YESTERDAY_YMD)"
        echo "ðŸ“… Beijing 2 Days Ago: $BJ_2DAYSAGO_YEAR-$BJ_2DAYSAGO_MONTH-$BJ_2DAYSAGO_DAY (YMD: $BJ_2DAYSAGO_YMD)"
        echo ""

        # ðŸ”¥ DIAGNOSTIC: Print raw environment variable
        echo "ðŸ“‹ Raw CONFIG_LIST environment variable:"
        echo "========================================"
        printf '%s\n' "$CONFIG_LIST"
        echo "========================================"
        echo "CONFIG_LIST length: ${#CONFIG_LIST}"
        
        readarray -t CONFIG_ARRAY <<<"$CONFIG_LIST"

        echo "ðŸ“‹ Found ${#CONFIG_ARRAY[@]} config entries:"
        for i in "${!CONFIG_ARRAY[@]}"; do
          config="${CONFIG_ARRAY[$i]}"
          if [[ -n "$config" ]]; then
            echo "  [$i]: [$config]"
            # Remove leading/trailing whitespace
            config=$(echo "$config" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
            if [[ -n "$config" ]]; then
              IFS=';' read -r URL_TEMPLATE OUTPUT_NAME <<< "$config"
              echo "    Template: [$URL_TEMPLATE]"
              echo "    Output: [$OUTPUT_NAME]"
            fi
          fi
        done
        echo ""

        DATE_FALLBACK=(
          "today"
          "yesterday" 
          "two_days_ago"
        )

        for config in "${CONFIG_ARRAY[@]}"; do
          # Skip empty lines
          [[ -z "$config" ]] && continue
          
          IFS=';' read -r URL_TEMPLATE OUTPUT_NAME <<< "$config"
          
          # Validate template and output name
          [[ -z "$URL_TEMPLATE" || -z "$OUTPUT_NAME" ]] && continue

          downloaded=false

          echo "ðŸ” Processing $OUTPUT_NAME..."
          echo "   Template: $URL_TEMPLATE"

          for date_key in "${DATE_FALLBACK[@]}"; do
            case "$date_key" in
              "today")
                Y="$BJ_TODAY_YEAR"; M="$BJ_TODAY_MONTH"; D="$BJ_TODAY_DAY"; YMD="$BJ_TODAY_YMD"
                DATE_DESC="Beijing Today"
                ;;
              "yesterday")
                Y="$BJ_YESTERDAY_YEAR"; M="$BJ_YESTERDAY_MONTH"; D="$BJ_YESTERDAY_DAY"; YMD="$BJ_YESTERDAY_YMD"
                DATE_DESC="Beijing Yesterday"
                ;;
              "two_days_ago")
                Y="$BJ_2DAYSAGO_YEAR"; M="$BJ_2DAYSAGO_MONTH"; D="$BJ_2DAYSAGO_DAY"; YMD="$BJ_2DAYSAGO_YMD"
                DATE_DESC="Beijing 2 Days Ago"
                ;;
            esac

            # Debug: Show what variables are being used
            echo "   Using: year=$Y, month=$M, day=$D, ymd=$YMD (from $DATE_DESC)"

            # ðŸ”¥ SAFE URL RENDERING: Use sed to avoid Bash parameter expansion issues with '/'
            RENDERED_URL="$URL_TEMPLATE"
            echo "   Before replace: $RENDERED_URL"
            
            RENDERED_URL=$(echo "$RENDERED_URL" | sed "s|{{year}}|$Y|g")
            echo "   After year: $RENDERED_URL"
            
            RENDERED_URL=$(echo "$RENDERED_URL" | sed "s|{{month}}|$M|g")
            echo "   After month: $RENDERED_URL"
            
            RENDERED_URL=$(echo "$RENDERED_URL" | sed "s|{{day}}|$D|g")
            echo "   After day: $RENDERED_URL"
            
            RENDERED_URL=$(echo "$RENDERED_URL" | sed "s|{{ymd}}|$YMD|g")
            echo "   After ymd: $RENDERED_URL"
            
            echo "   ðŸš€ Final URL to try: $RENDERED_URL"
            echo ""

            # ðŸ”¥ Download to temporary file first
            TEMP_FILE="${OUTPUT_NAME}.tmp"
            
            # Download with browser-like User-Agent (avoid anti-bot)
            if curl -f -L -A "Mozilla/5.0 (compatible; GitHub-Actions)" \
                    --retry 2 --retry-delay 3 --max-time 25 \
                    -o "$TEMP_FILE" "$RENDERED_URL"; then

              echo "   âœ… Download successful (HTTP 200)"
              
              # Check file content: ONLY check if non-empty
              if [ -s "$TEMP_FILE" ]; then
                echo "   ðŸ“„ Temp file size: $(stat -c%s "$TEMP_FILE") bytes"
                
                # ðŸ”¥ ONLY if temp file is valid, move it to final name (replacing old file)
                mv "$TEMP_FILE" "$OUTPUT_NAME"
                echo "   âœ… Valid file saved as $OUTPUT_NAME (replaced old version if existed)"
                downloaded=true
                break
              else
                echo "   âš ï¸  Downloaded temp file is empty, keeping old file"
                rm -f "$TEMP_FILE"
              fi
            else
              echo "   âŒ Download failed (HTTP error or timeout)"
              # Try to get headers to see what happened
              if [ -n "$RENDERED_URL" ]; then
                curl -f -s -I -L -A "Mozilla/5.0 (compatible; GitHub-Actions)" "$RENDERED_URL" 2>/dev/null | head -n 5 || echo "   (Failed to get headers)"
              else
                echo "   (RENDERED_URL is empty)"
              fi
              echo ""
            fi
          done

          if [ "$downloaded" = false ]; then
            echo "::warning::No valid config found for $OUTPUT_NAME after 3-day fallback"
            # If no new file was downloaded successfully, old file (if any) is preserved
          else
            echo "   ðŸŽ‰ Successfully downloaded $OUTPUT_NAME"
          fi
          echo "   ----------------------------------------"
        done

    - name: Debug - List downloaded files
      run: |
        echo "ðŸ“¥ Downloaded files:"
        ls -la *_latest.* 2>/dev/null || echo "No _latest files found."

    - name: Check for actual Git changes (improved)
      id: git_check
      run: |
        # Check if there are any changes in *_latest.* files
        if git diff --quiet HEAD -- *_latest.* 2>/dev/null; then
          # No changes in the files we care about
          echo "has_changes=false" >> "$GITHUB_OUTPUT"
          echo "Files exist but content unchanged. No commit needed."
        else
          # There are changes in *_latest.* files
          if ls *_latest.* 1> /dev/null 2>&1; then
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
            echo "Changes detected in config files:"
            git status --porcelain -- *_latest.*
          else
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            echo "No config files to commit."
          fi
        fi

    - name: Commit and push changes
      if: steps.git_check.outputs.has_changes == 'true'
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "Bot: Daily config update (Beijing ${{ steps.dates.outputs.BJ_TODAY_YMD }})"
        file_pattern: '*_latest.*'
        add_options: '-A'
        token: ${{ secrets.REPO_ACCESS_TOKEN }}
        skip_dirty_check: true
        commit_user_name: 'github-actions[bot]'
        commit_user_email: 'github-actions[bot]@users.noreply.github.com'
