name: Daily Multi-Config Update

on:
  schedule:
    - cron: '10 0 * * *'  # æ¯å¤© UTC 00:10ï¼ˆåŒ—äº¬æ—¶é—´ 08:10ï¼‰
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.REPO_ACCESS_TOKEN }}

    - name: Generate date contexts (UTC and Beijing)
      id: dates
      run: |
        # UTC æ—¥æœŸ
        UTC_YEAR=$(date -u +%Y)
        UTC_MONTH=$(date -u +%m)
        UTC_DAY=$(date -u +%d)
        UTC_YMD=$(date -u +%Y%m%d)

        # åŒ—äº¬æ—¶é—´ï¼ˆUTC+8ï¼‰
        BJ_YEAR=$(date -u -d '+8 hours' +%Y)
        BJ_MONTH=$(date -u -d '+8 hours' +%m)
        BJ_DAY=$(date -u -d '+8 hours' +%d)
        BJ_YMD=$(date -u -d '+8 hours' +%Y%m%d)

        # æ˜¨å¤©ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
        BJ_YESTERDAY_YMD=$(date -u -d '+8 hours -1 day' +%Y%m%d)
        BJ_YESTERDAY_YEAR=$(date -u -d '+8 hours -1 day' +%Y)
        BJ_YESTERDAY_MONTH=$(date -u -d '+8 hours -1 day' +%m)
        BJ_YESTERDAY_DAY=$(date -u -d '+8 hours -1 day' +%d)

        # è¾“å‡ºæ‰€æœ‰æ—¥æœŸä¸Šä¸‹æ–‡ï¼ˆYMD ç”¨äºæ—§æ ¼å¼ï¼Œåˆ†é‡ç”¨äºæ–°æ¨¡æ¿ï¼‰
        echo "BJ_TODAY_YMD=$BJ_YMD" >> "$GITHUB_OUTPUT"
        echo "BJ_YESTERDAY_YMD=$BJ_YESTERDAY_YMD" >> "$GITHUB_OUTPUT"
        echo "UTC_TODAY_YMD=$UTC_YMD" >> "$GITHUB_OUTPUT"

        # åŒ—äº¬æ—¶é—´åˆ†é‡ï¼ˆç”¨äºæ¨¡æ¿ï¼‰
        echo "BJ_YEAR=$BJ_YEAR" >> "$GITHUB_OUTPUT"
        echo "BJ_MONTH=$BJ_MONTH" >> "$GITHUB_OUTPUT"
        echo "BJ_DAY=$BJ_DAY" >> "$GITHUB_OUTPUT"
        echo "BJ_YESTERDAY_YEAR=$BJ_YESTERDAY_YEAR" >> "$GITHUB_OUTPUT"
        echo "BJ_YESTERDAY_MONTH=$BJ_YESTERDAY_MONTH" >> "$GITHUB_OUTPUT"
        echo "BJ_YESTERDAY_DAY=$BJ_YESTERDAY_DAY" >> "$GITHUB_OUTPUT"

    - name: Download configs with universal template support
      run: |
        # ========== é…ç½®æ ¼å¼è¯´æ˜ ==========
        # æ¯è¡Œæ ¼å¼: "URL_TEMPLATE;OUTPUT_NAME;MODE"
        # - MODE = "LEGACY" : ä½¿ç”¨ YMD æ—¥æœŸï¼ˆå¦‚ 20251202ï¼‰ï¼Œç”¨äº freeclashnode
        # - MODE = "TEMPLATE" : ä½¿ç”¨ {{year}}, {{month}}, {{day}} æ¨¡æ¿ï¼Œç”¨äº mibei77 ç­‰
        #
        # æ³¨æ„ï¼šLEGACY æ¨¡å¼ä»æ”¯æŒæ—¥æœŸå›é€€ï¼ˆé€šè¿‡ YMD åˆ—è¡¨ï¼‰

        CONFIG_LIST=(
          # --- æ ‡å‡†æºï¼ˆfreeclashnodeï¼‰---
          "https://node.freeclashnode.com/uploads/{{year}}/{{month}}/0-{{ymd}}.yaml;freeclashnode-0_latest.yaml;TEMPLATE"
          "https://node.freeclashnode.com/uploads/{{year}}/{{month}}/1-{{ymd}}.yaml;freeclashnode-1_latest.yaml;TEMPLATE"
          "https://node.freeclashnode.com/uploads/{{year}}/{{month}}/2-{{ymd}}.yaml;freeclashnode-2_latest.yaml;TEMPLATE"
          "https://node.freeclashnode.com/uploads/{{year}}/{{month}}/3-{{ymd}}.yaml;freeclashnode-3_latest.yaml;TEMPLATE"
          "https://node.freeclashnode.com/uploads/{{year}}/{{month}}/4-{{ymd}}.yaml;freeclashnode-4_latest.yaml;TEMPLATE"

          # --- ç‰¹æ®Šæºï¼ˆmibei77ï¼‰---
          "https://mm.mibei77.com/{{year}}.{{month}}/{{day}}.{{month}}Clashikf.yaml;mibei77_latest.yaml;TEMPLATE"

          # --- ä½ å¯ä»¥ç»§ç»­æ·»åŠ æ›´å¤š ---
          # "https://example.com/{{year}}/{{month}}/{{day}}/config.yaml;example_latest.yaml;TEMPLATE"
        )

        # æ—¥æœŸå›é€€åºåˆ—ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰
        DATE_FALLBACK=(
          "bj_today"
          "bj_yesterday"
          "utc_today"
        )

        for config in "${CONFIG_LIST[@]}"; do
          IFS=';' read -r URL_TEMPLATE OUTPUT_NAME MODE <<< "$config"
          downloaded=false

          echo "ğŸ” Processing $OUTPUT_NAME (mode: $MODE)..."

          for date_key in "${DATE_FALLBACK[@]}"; do
            case "$date_key" in
              "bj_today")
                Y=${{ steps.dates.outputs.BJ_YEAR }}
                M=${{ steps.dates.outputs.BJ_MONTH }}
                D=${{ steps.dates.outputs.BJ_DAY }}
                YMD=${{ steps.dates.outputs.BJ_TODAY_YMD }}
                ;;
              "bj_yesterday")
                Y=${{ steps.dates.outputs.BJ_YESTERDAY_YEAR }}
                M=${{ steps.dates.outputs.BJ_YESTERDAY_MONTH }}
                D=${{ steps.dates.outputs.BJ_YESTERDAY_DAY }}
                YMD=${{ steps.dates.outputs.BJ_YESTERDAY_YMD }}
                ;;
              "utc_today")
                Y=${{ steps.dates.outputs.UTC_YEAR }}
                M=${{ steps.dates.outputs.UTC_MONTH }}
                D=${{ steps.dates.outputs.UTC_DAY }}
                YMD=${{ steps.dates.outputs.UTC_TODAY_YMD }}
                ;;
            esac

            # æ¸²æŸ“æ¨¡æ¿ï¼šæ›¿æ¢ {{year}}, {{month}}, {{day}}, {{ymd}}
            RENDERED_URL="$URL_TEMPLATE"
            RENDERED_URL="${RENDERED_URL//{{year}}/$Y}"
            RENDERED_URL="${RENDERED_URL//{{month}}/$M}"
            RENDERED_URL="${RENDERED_URL//{{day}}/$D}"
            RENDERED_URL="${RENDERED_URL//{{ymd}}/$YMD}"

            echo "  â†’ Trying: $RENDERED_URL"

            if curl -f -L --retry 2 --retry-delay 3 --max-time 25 -o "$OUTPUT_NAME" "$RENDERED_URL"; then
              echo "  âœ… Success! Saved as $OUTPUT_NAME (date key: $date_key)"
              downloaded=true
              break
            else
              echo "  âš ï¸ Failed: $RENDERED_URL"
            fi
          done

          if [ "$downloaded" = false ]; then
            echo "::warning::All attempts failed for $OUTPUT_NAME"
          fi
        done

    - name: Check if any valid config files exist
      id: check
      run: |
        if ls *_latest.* 1> /dev/null 2>&1; then
          echo "has_files=true" >> "$GITHUB_OUTPUT"
        else
          echo "has_files=false" >> "$GITHUB_OUTPUT"
        fi

    - name: Commit and push changes
      if: steps.check.outputs.has_files == 'true'
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "Bot: Daily config update ($(date -u +%Y%m%d))"
        file_pattern: '*_latest.*'
        add_options: '-A'                 # â† å…³é”®ï¼æ”¯æŒæ–°å¢æ–‡ä»¶
        token: ${{ secrets.REPO_ACCESS_TOKEN }}
        skip_dirty_check: true
        commit_user_name: 'github-actions[bot]'
        commit_user_email: 'github-actions[bot]@users.noreply.github.com'
