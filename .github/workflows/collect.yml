name: Daily Multi-Config Update

on:
  schedule:
    - cron: '10 0 * * *'  # UTC 00:10 = Beijing 08:10
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.REPO_ACCESS_TOKEN }}

    - name: Generate date contexts (UTC and Beijing)
      id: dates
      run: |
        # UTC
        UTC_YEAR=$(date -u +%Y)
        UTC_MONTH=$(date -u +%m)
        UTC_DAY=$(date -u +%d)
        UTC_YMD=$(date -u +%Y%m%d)

        # Beijing Time (UTC+8)
        BJ_YEAR=$(date -u -d '+8 hours' +%Y)
        BJ_MONTH=$(date -u -d '+8 hours' +%m)
        BJ_DAY=$(date -u -d '+8 hours' +%d)
        BJ_YMD=$(date -u -d '+8 hours' +%Y%m%d)

        # Beijing Yesterday
        BJ_YESTERDAY_YEAR=$(date -u -d '+8 hours -1 day' +%Y)
        BJ_YESTERDAY_MONTH=$(date -u -d '+8 hours -1 day' +%m)
        BJ_YESTERDAY_DAY=$(date -u -d '+8 hours -1 day' +%d)
        BJ_YESTERDAY_YMD=$(date -u -d '+8 hours -1 day' +%Y%m%d)

        # Output for next steps
        echo "BJ_YEAR=$BJ_YEAR" >> "$GITHUB_OUTPUT"
        echo "BJ_MONTH=$BJ_MONTH" >> "$GITHUB_OUTPUT"
        echo "BJ_DAY=$BJ_DAY" >> "$GITHUB_OUTPUT"
        echo "BJ_YMD=$BJ_YMD" >> "$GITHUB_OUTPUT"
        echo "BJ_YESTERDAY_YEAR=$BJ_YESTERDAY_YEAR" >> "$GITHUB_OUTPUT"
        echo "BJ_YESTERDAY_MONTH=$BJ_YESTERDAY_MONTH" >> "$GITHUB_OUTPUT"
        echo "BJ_YESTERDAY_DAY=$BJ_YESTERDAY_DAY" >> "$GITHUB_OUTPUT"
        echo "BJ_YESTERDAY_YMD=$BJ_YESTERDAY_YMD" >> "$GITHUB_OUTPUT"
        echo "UTC_YEAR=$UTC_YEAR" >> "$GITHUB_OUTPUT"
        echo "UTC_MONTH=$UTC_MONTH" >> "$GITHUB_OUTPUT"
        echo "UTC_DAY=$UTC_DAY" >> "$GITHUB_OUTPUT"
        echo "UTC_YMD=$UTC_YMD" >> "$GITHUB_OUTPUT"

    - name: Download configs with universal template
      # ‚úÖ ÂÖ≥ÈîÆÔºöÈÄöËøá env Ê≥®ÂÖ•ÂèòÈáèÔºå‰ΩøÂÖ∂Âú® Bash ‰∏≠ÂèØÁî®
      env:
        BJ_YEAR: ${{ steps.dates.outputs.BJ_YEAR }}
        BJ_MONTH: ${{ steps.dates.outputs.BJ_MONTH }}
        BJ_DAY: ${{ steps.dates.outputs.BJ_DAY }}
        BJ_YMD: ${{ steps.dates.outputs.BJ_YMD }}
        BJ_YESTERDAY_YEAR: ${{ steps.dates.outputs.BJ_YESTERDAY_YEAR }}
        BJ_YESTERDAY_MONTH: ${{ steps.dates.outputs.BJ_YESTERDAY_MONTH }}
        BJ_YESTERDAY_DAY: ${{ steps.dates.outputs.BJ_YESTERDAY_DAY }}
        BJ_YESTERDAY_YMD: ${{ steps.dates.outputs.BJ_YESTERDAY_YMD }}
        UTC_YEAR: ${{ steps.dates.outputs.UTC_YEAR }}
        UTC_MONTH: ${{ steps.dates.outputs.UTC_MONTH }}
        UTC_DAY: ${{ steps.dates.outputs.UTC_DAY }}
        UTC_YMD: ${{ steps.dates.outputs.UTC_YMD }}
      run: |
        echo "üîç Debug: Today (Beijing) = $BJ_YEAR-$BJ_MONTH-$BJ_DAY ($BJ_YMD)"
        echo "üîç Debug: Yesterday (Beijing) = $BJ_YESTERDAY_YEAR-$BJ_YESTERDAY_MONTH-$BJ_YESTERDAY_DAY"

        CONFIG_LIST=(
          "https://node.freeclashnode.com/uploads/{{year}}/{{month}}/0-{{ymd}}.yaml;freeclashnode-0_latest.yaml"
          "https://node.freeclashnode.com/uploads/{{year}}/{{month}}/1-{{ymd}}.yaml;freeclashnode-1_latest.yaml"
          "https://node.freeclashnode.com/uploads/{{year}}/{{month}}/2-{{ymd}}.yaml;freeclashnode-2_latest.yaml"
          "https://node.freeclashnode.com/uploads/{{year}}/{{month}}/3-{{ymd}}.yaml;freeclashnode-3_latest.yaml"
          "https://node.freeclashnode.com/uploads/{{year}}/{{month}}/4-{{ymd}}.yaml;freeclashnode-4_latest.yaml"
          "https://mm.mibei77.com/{{year}}.{{month}}/{{day}}.{{month}}Clashikf.yaml;mibei77_latest.yaml"
        )

        DATE_FALLBACK=(
          "bj_today"
          "bj_yesterday"
          "utc_today"
        )

        for config in "${CONFIG_LIST[@]}"; do
          IFS=';' read -r URL_TEMPLATE OUTPUT_NAME <<< "$config"
          rm -f "$OUTPUT_NAME"  # Clean previous
          downloaded=false

          for date_key in "${DATE_FALLBACK[@]}"; do
            case "$date_key" in
              "bj_today")
                Y="$BJ_YEAR"; M="$BJ_MONTH"; D="$BJ_DAY"; YMD="$BJ_YMD"
                ;;
              "bj_yesterday")
                Y="$BJ_YESTERDAY_YEAR"; M="$BJ_YESTERDAY_MONTH"; D="$BJ_YESTERDAY_DAY"; YMD="$BJ_YESTERDAY_YMD"
                ;;
              "utc_today")
                Y="$UTC_YEAR"; M="$UTC_MONTH"; D="$UTC_DAY"; YMD="$UTC_YMD"
                ;;
            esac

            RENDERED_URL="$URL_TEMPLATE"
            RENDERED_URL="${RENDERED_URL//{{year}}/$Y}"
            RENDERED_URL="${RENDERED_URL//{{month}}/$M}"
            RENDERED_URL="${RENDERED_URL//{{day}}/$D}"
            RENDERED_URL="${RENDERED_URL//{{ymd}}/$YMD}"

            echo "  ‚Üí Trying: $RENDERED_URL"
            if curl -f -L --retry 2 --retry-delay 2 --max-time 20 -o "$OUTPUT_NAME" "$RENDERED_URL"; then
              echo "  ‚úÖ Success: $OUTPUT_NAME"
              downloaded=true
              break
            else
              echo "  ‚ö†Ô∏è Failed: HTTP error or timeout"
            fi
          done

          if [ "$downloaded" = false ]; then
            rm -f "$OUTPUT_NAME"
            echo "::warning::All attempts failed for $OUTPUT_NAME"
          fi
        done

    - name: Check for actual Git changes
      id: git_check
      run: |
        if [ -n "$(git status --porcelain)" ]; then
          echo "has_changes=true" >> "$GITHUB_OUTPUT"
        else
          echo "has_changes=false" >> "$GITHUB_OUTPUT"
        fi

    - name: Commit and push changes
      if: steps.git_check.outputs.has_changes == 'true'
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "Bot: Daily config update (${{ steps.dates.outputs.BJ_YMD }})"
        file_pattern: '*_latest.*'
        add_options: '-A'
        token: ${{ secrets.REPO_ACCESS_TOKEN }}
        skip_dirty_check: true
